#!/bin/bash

set -e

echo "01. Installing packages..."

# Install Xcode Command Line Tools if not present
if ! xcode-select -p &> /dev/null; then
    echo "Installing Xcode Command Line Tools..."
    xcode-select --install
    echo "Please complete the Xcode Command Line Tools installation and run this script again."
    exit 0
else
    echo "Xcode Command Line Tools already installed"
fi

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Setup Homebrew environment for Apple Silicon
    if [[ $(uname -m) == "arm64" ]]; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
else
    echo "Homebrew already installed"
fi

# Update Homebrew
echo "Updating Homebrew..."
brew update

# Install packages using Brewfile
echo "Installing packages from Brewfile..."

# Check if expect is available, install if not
if ! command -v expect &> /dev/null; then
    echo "Installing expect for automated password input..."
    brew install expect
fi

# Create expect script for automated password input
cat > /tmp/brew_install.exp << 'EOF'
#!/usr/bin/expect -f
set timeout -1
set password "{{ .sudoPassword }}"

spawn brew bundle --file={{ .chezmoi.sourceDir }}/Brewfile

expect {
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "password for" {
        send "$password\r"
        exp_continue
    }
    eof
}
EOF

chmod +x /tmp/brew_install.exp

# Run the installation with expect
/tmp/brew_install.exp

# Clean up
rm -f /tmp/brew_install.exp

# Install Oh My Zsh if not present
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
else
    echo "Oh My Zsh already installed"
fi

# Install Zsh plugins
echo "Installing Zsh plugins..."

# zsh-autosuggestions
if [ ! -d "${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions" ]; then
    git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
fi

# zsh-syntax-highlighting
if [ ! -d "${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting" ]; then
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
fi

echo "Package installation completed"
echo "Please restart your terminal to ensure all changes take effect"
