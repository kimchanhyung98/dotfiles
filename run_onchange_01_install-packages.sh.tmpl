#!/bin/bash

set -e

echo "01. install packages"

# Require Xcode Command Line Tools
echo "[xcode][check] command line tools"
if ! xcode-select -p &> /dev/null; then
    echo "[xcode][install] command line tools not found; install them before running" 1>&2
    xcode-select --install
fi

# Ensure brew environment in current session
eval "$(brew shellenv)"

# Update and upgrade Homebrew
echo "[brew][update] start"
brew update
brew upgrade || true
brew upgrade --cask || true

# Install packages using Brewfile
echo "Installing packages from Brewfile..."

# Check if expect is available, install if not
if ! command -v expect &> /dev/null; then
    echo "Installing expect for automated password input..."
    brew install expect
fi

# Create expect script for automated password input
cat > /tmp/brew_install.exp << 'EOF'
#!/usr/bin/expect -f
set timeout -1
set password "{{ .sudoPassword }}"

spawn brew bundle --file={{ .chezmoi.sourceDir }}/Brewfile

expect {
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "password for" {
        send "$password\r"
        exp_continue
    }
    eof
}
EOF

chmod +x /tmp/brew_install.exp

# Run the installation with expect
/tmp/brew_install.exp

# Clean up
rm -f /tmp/brew_install.exp

# Install Oh My Zsh if not present
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "[oh-my-zsh][install] start"
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
else
    echo "[oh-my-zsh][update] start"
    git -C "$HOME/.oh-my-zsh" pull --ff-only || true
fi

# Install Zsh plugins
echo "[zsh][install] plugins"

# zsh-autosuggestions
if [ ! -d "${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions" ]; then
    git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
fi

# zsh-syntax-highlighting
if [ ! -d "${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting" ]; then
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
fi

echo "01. package installation completed"
