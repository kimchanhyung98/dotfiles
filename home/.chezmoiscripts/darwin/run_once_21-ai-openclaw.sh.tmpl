#!/bin/bash
#
# AI OpenClaw: OpenClaw, peon-ping adapter

{{ if ne .chezmoi.os "darwin" }}
exit 0
{{ end }}

set -eufo pipefail

echo "[ai-openclaw]"

# OpenClaw
# - 설치 + launchd 데몬 등록을 onboard --install-daemon 으로 한번에 처리
if ! command -v openclaw &>/dev/null; then
    echo "Installing OpenClaw..."
    npm install -g openclaw@latest || echo "[ai-openclaw][warning] OpenClaw installation failed"
else
    echo "OpenClaw: already installed ($(openclaw --version 2>/dev/null || echo 'installed'))"
fi

if command -v openclaw &>/dev/null; then
    if openclaw daemon status --json 2>/dev/null | grep -q '"loaded".*true'; then
        echo "OpenClaw daemon: already registered"
    else
        echo "Registering OpenClaw daemon..."
        openclaw onboard --install-daemon || echo "[ai-openclaw][warning] onboard --install-daemon failed (manual setup required)"
    fi
fi

# peon-ping adapter for OpenClaw
# - OpenClaw용 작업 알림 사운드 어댑터
if [ ! -f "$HOME/.openclaw/hooks/peon-ping/.installed" ]; then
    echo "Installing peon-ping adapter for OpenClaw..."
    curl -fsSL https://raw.githubusercontent.com/PeonPing/peon-ping/main/adapters/openclaw.sh | bash || echo "[ai-openclaw][warning] peon-ping adapter installation failed"
else
    echo "peon-ping adapter: already installed"
fi

echo "[ai-openclaw] done"
