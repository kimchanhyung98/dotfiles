#!/bin/bash
#
# AI Claude: SuperClaude, peon-ping

{{ if ne .chezmoi.os "darwin" }}
exit 0
{{ end }}

set -eufo pipefail

echo "[ai-claude]"

# SuperClaude
# - Claude Code 확장 프레임워크 (페르소나, 명령어, 플래그 시스템)
if ! command -v superclaude &>/dev/null; then
    echo "Installing SuperClaude..."
    pipx install superclaude || echo "[ai-claude][warning] SuperClaude installation failed"
    SuperClaude install --force --yes || true
else
    echo "SuperClaude: already installed"
fi

# Augment Context Engine MCP
# - credentials.json 에서 토큰을 읽어 env 포함 (토큰 없으면 등록하지 않음)
if ! claude mcp list 2>/dev/null | grep -q "auggie"; then
    AUGMENT_CRED="$HOME/.config/augment/credentials.json"
    if [ -f "$AUGMENT_CRED" ]; then
        AUG_TOKEN=$(jq -r '.accessToken // empty' "$AUGMENT_CRED" 2>/dev/null)
        AUG_URL=$(jq -r '.tenantURL // empty' "$AUGMENT_CRED" 2>/dev/null)
    fi
    if [ -n "${AUG_TOKEN:-}" ] && [ -n "${AUG_URL:-}" ]; then
        echo "Adding Augment MCP to Claude Code..."
        claude mcp add-json auggie --scope user "{\"type\":\"stdio\",\"command\":\"auggie\",\"args\":[\"--mcp\",\"--mcp-auto-workspace\"],\"env\":{\"AUGMENT_API_TOKEN\":\"$AUG_TOKEN\",\"AUGMENT_API_URL\":\"$AUG_URL\"}}" || echo "[ai-claude][warning] Augment MCP addition failed"
    else
        echo "[ai-claude][warning] Augment token not found, skipping MCP registration (run 'auggie login' first)"
    fi
else
    echo "Augment MCP: already configured"
fi

# peon-ping
# - 작업 완료 알림 사운드 (임시파일 다운로드 후 실행)
if [ ! -d "$HOME/.claude/hooks/peon-ping" ]; then
    echo "Installing peon-ping..."
    installer=$(mktemp)
    if curl -fsSL https://raw.githubusercontent.com/PeonPing/peon-ping/main/install.sh -o "$installer" 2>/dev/null; then
        bash "$installer" --packs=hal_2001,protoss,sc_marine,sc_scv || echo "[ai-claude][warning] peon-ping installation failed"
        rm -f "$installer"
    else
        rm -f "$installer"
        echo "[ai-claude][warning] peon-ping download failed"
    fi
else
    echo "peon-ping: already installed"
fi

echo "[ai-claude] done"
