#!/bin/bash
#
# AI OpenClaw: OpenClaw, launchd daemon, claude-mem integration
# Runs once on first setup

{{ if ne .chezmoi.os "darwin" }}
exit 0
{{ end }}

set -eufo pipefail

echo "=== AI OpenClaw ==="

# OpenClaw
if ! command -v openclaw &>/dev/null; then
    echo "Installing OpenClaw..."
    npm install -g @openclaw/openclaw@latest
else
    echo "OpenClaw: already installed ($(openclaw --version 2>/dev/null || echo 'installed'))"
fi

# launchd daemon registration
PLIST_NAME="com.openclaw.daemon"
PLIST_PATH="$HOME/Library/LaunchAgents/${PLIST_NAME}.plist"

if [ ! -f "$PLIST_PATH" ]; then
    echo "Registering OpenClaw launchd daemon..."
    OPENCLAW_BIN=$(command -v openclaw 2>/dev/null || echo "$HOME/.local/bin/openclaw")
    cat > "$PLIST_PATH" << PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${PLIST_NAME}</string>
    <key>ProgramArguments</key>
    <array>
        <string>${OPENCLAW_BIN}</string>
        <string>daemon</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>${HOME}/Library/Logs/openclaw.log</string>
    <key>StandardErrorPath</key>
    <string>${HOME}/Library/Logs/openclaw.error.log</string>
</dict>
</plist>
PLIST
    launchctl load "$PLIST_PATH" 2>/dev/null || echo "Warning: launchd load failed"
else
    echo "OpenClaw daemon: already registered"
fi

# claude-mem integration (download-then-execute for supply chain safety)
if [ ! -f "$HOME/.claude-mem/.installed" ]; then
    echo "Setting up claude-mem for OpenClaw..."
    installer=$(mktemp)
    if curl -fsSL https://raw.githubusercontent.com/thedotmack/claude-mem/e975555/install/openclaw.sh -o "$installer" 2>/dev/null; then
        bash "$installer" || echo "Warning: claude-mem OpenClaw integration failed"
        rm -f "$installer"
    else
        rm -f "$installer"
        echo "Warning: claude-mem download failed"
    fi
else
    echo "claude-mem: already installed"
fi

echo "=== AI OpenClaw complete ==="
