#!/bin/bash
#
# AI Codex: oh-my-codex, superpowers (copy), profile init

{{ if ne .chezmoi.os "darwin" }}
exit 0
{{ end }}

set -eufo pipefail

echo "[ai-codex]"

# oh-my-codex
# - Codex CLI 멀티 에이전트 오케스트레이션 (프롬프트, 스킬, 팀 실행)
if ! command -v omx &>/dev/null; then
    echo "Installing oh-my-codex..."
    npm install -g oh-my-codex || echo "[ai-codex][warning] oh-my-codex installation failed"
else
    echo "oh-my-codex: already installed"
fi

# superpowers for Codex
# - ~/superpowers에서 Codex 스킬 경로로 복사 (개별 커스텀 가능)
CODEX_SKILLS_DIR="$HOME/.agents/skills/superpowers"

if [ -d "$HOME/superpowers/skills" ] && [ ! -d "$CODEX_SKILLS_DIR" ]; then
    echo "Copying superpowers to Codex skills..."
    mkdir -p "$(dirname "$CODEX_SKILLS_DIR")"
    cp -r "$HOME/superpowers/skills" "$CODEX_SKILLS_DIR"
fi

# Augment Context Engine MCP
# - credentials.json 에서 토큰을 읽어 env 포함 (토큰 없으면 등록하지 않음)
if ! codex mcp list 2>/dev/null | grep -q "codebase-retrieval"; then
    AUGMENT_CRED="$HOME/.config/augment/credentials.json"
    if [ -f "$AUGMENT_CRED" ]; then
        AUG_TOKEN=$(jq -r '.accessToken // empty' "$AUGMENT_CRED" 2>/dev/null)
        AUG_URL=$(jq -r '.tenantURL // empty' "$AUGMENT_CRED" 2>/dev/null)
    fi
    if [ -n "${AUG_TOKEN:-}" ] && [ -n "${AUG_URL:-}" ]; then
        echo "Adding Augment MCP to Codex..."
        codex mcp add codebase-retrieval --env "AUGMENT_API_TOKEN=$AUG_TOKEN" --env "AUGMENT_API_URL=$AUG_URL" -- auggie --mcp --mcp-auto-workspace || echo "[ai-codex][warning] Augment MCP addition failed"
    else
        echo "[ai-codex][warning] Augment token not found, skipping MCP registration (run 'auggie login' first)"
    fi
else
    echo "Augment MCP: already configured"
fi

# 초기 설정 및 검증
mkdir -p "$HOME/.codex"
if [ ! -f "$HOME/.codex/.profile-initialized" ]; then
    echo "Initializing oh-my-codex..."
    if omx setup 2>/dev/null && omx doctor 2>/dev/null; then
        touch "$HOME/.codex/.profile-initialized"
    else
        echo "[ai-codex][warning] omx setup/doctor failed"
    fi
fi

echo "[ai-codex] done"
