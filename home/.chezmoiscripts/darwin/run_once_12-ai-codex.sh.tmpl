#!/bin/bash
#
# AI Codex: Codex CLI, oh-my-codex, superpowers (clone+symlink), profile init
# Runs once on first setup

{{ if ne .chezmoi.os "darwin" }}
exit 0
{{ end }}

set -eufo pipefail

echo "=== AI Codex ==="

# Codex CLI
if ! command -v codex &>/dev/null; then
    echo "Installing Codex CLI..."
    npm install -g @openai/codex
else
    echo "Codex CLI: already installed ($(codex --version 2>/dev/null || echo 'installed'))"
fi

# oh-my-codex
if ! command -v oh-my-codex &>/dev/null; then
    echo "Installing oh-my-codex..."
    npm install -g oh-my-codex
else
    echo "oh-my-codex: already installed"
fi

# superpowers for Codex (clone + symlink)
SUPERPOWERS_DIR="$HOME/.local/share/superpowers"
CODEX_SKILLS_DIR="$HOME/.agents/skills/superpowers"

if [ ! -d "$SUPERPOWERS_DIR" ]; then
    echo "Cloning superpowers..."
    git clone https://github.com/obra/superpowers.git "$SUPERPOWERS_DIR"
fi

if [ ! -L "$CODEX_SKILLS_DIR" ]; then
    echo "Linking superpowers to Codex skills..."
    mkdir -p "$(dirname "$CODEX_SKILLS_DIR")"
    ln -sf "$SUPERPOWERS_DIR" "$CODEX_SKILLS_DIR"
fi

# Initialize default profile
mkdir -p "$HOME/.codex"
if [ ! -f "$HOME/.codex/.profile-initialized" ]; then
    echo "Initializing Codex default profile..."
    oh-my-codex init 2>/dev/null || echo "Warning: oh-my-codex init failed"
    touch "$HOME/.codex/.profile-initialized"
fi

echo "=== AI Codex complete ==="
