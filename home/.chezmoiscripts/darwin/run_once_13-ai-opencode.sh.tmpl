#!/bin/bash
#
# AI OpenCode: OpenCode, oh-my-opencode, superpowers (clone+symlink+plugin)
# Runs once on first setup

{{ if ne .chezmoi.os "darwin" }}
exit 0
{{ end }}

set -eufo pipefail

echo "=== AI OpenCode ==="

# OpenCode
if ! command -v opencode &>/dev/null; then
    echo "Installing OpenCode..."
    npm install -g opencode-ai@1.2.6
else
    echo "OpenCode: already installed ($(opencode --version 2>/dev/null || echo 'installed'))"
fi

# oh-my-opencode
if ! command -v oh-my-opencode &>/dev/null; then
    echo "Installing oh-my-opencode..."
    npm install -g oh-my-opencode@3.7.1
else
    echo "oh-my-opencode: already installed"
fi

# superpowers for OpenCode (clone + symlink + plugin)
SUPERPOWERS_DIR="$HOME/.local/share/superpowers"
OPENCODE_PLUGINS_DIR="$HOME/.config/opencode/plugins/superpowers"

if [ ! -d "$SUPERPOWERS_DIR" ]; then
    echo "Cloning superpowers..."
    git clone https://github.com/obra/superpowers.git "$SUPERPOWERS_DIR"
    (cd "$SUPERPOWERS_DIR" && git checkout e16d611d871e194160a28a5991e84a22a84250c1)
fi

if [ ! -L "$OPENCODE_PLUGINS_DIR" ]; then
    echo "Linking superpowers to OpenCode plugins..."
    mkdir -p "$(dirname "$OPENCODE_PLUGINS_DIR")"
    ln -sf "$SUPERPOWERS_DIR" "$OPENCODE_PLUGINS_DIR"
fi

echo "=== AI OpenCode complete ==="
