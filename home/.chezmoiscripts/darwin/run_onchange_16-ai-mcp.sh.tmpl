#!/bin/bash
#
# AI MCP: register MCP servers (context7, sequential-thinking, augment-context-engine)
# Re-runs when MCP config changes
#
# MCP config hashes:
# - Claude: {{ include "dot_claude.json.tmpl" | sha256sum }}
# - OpenCode: {{ include "dot_config/opencode/opencode.json.tmpl" | sha256sum }}
# - Codex: {{ include "dot_codex/config.toml.tmpl" | sha256sum }}
# - Gemini: {{ include "dot_gemini/settings.json.tmpl" | sha256sum }}

{{ if ne .chezmoi.os "darwin" }}
exit 0
{{ end }}

set -eufo pipefail

echo "=== AI MCP ==="

# MCP servers are declared in multiple configuration files:
# - ~/.claude.json (dot_claude.json.tmpl)
# - ~/.config/opencode/opencode.json (dot_config/opencode/opencode.json.tmpl)
# - ~/.codex/config.toml (dot_codex/config.toml.tmpl)
# - ~/.gemini/settings.json (dot_gemini/settings.json.tmpl)
# This script ensures the npm packages are available

# context7 MCP server
echo "Ensuring context7 MCP server..."
npm list -g @upstash/context7-mcp &>/dev/null || npm install -g @upstash/context7-mcp 2>/dev/null || echo "Warning: context7 MCP install failed"

# sequential-thinking MCP server
echo "Ensuring sequential-thinking MCP server..."
npm list -g @modelcontextprotocol/server-sequential-thinking &>/dev/null || npm install -g @modelcontextprotocol/server-sequential-thinking 2>/dev/null || echo "Warning: sequential-thinking MCP install failed"

# augment-context-engine MCP server (Auggie CLI)
echo "Ensuring augment-context-engine MCP server..."
npm list -g @augmentcode/auggie &>/dev/null || npm install -g @augmentcode/auggie 2>/dev/null || echo "Warning: augment-context-engine MCP install failed"

echo "=== AI MCP complete ==="
