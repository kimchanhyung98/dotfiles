#!/bin/bash
#
# Install zerobrew (macOS only)
# Runs once on first setup, after Homebrew

{{ if ne .chezmoi.os "darwin" }}
exit 0
{{ end }}

set -eufo pipefail

echo "Checking zerobrew installation..."

ensure_zb_available() {
    if command -v zb &>/dev/null; then
        return 0
    fi

    for candidate in "$HOME/.local/bin/zb" "/opt/zerobrew/bin/zb" "/usr/local/zerobrew/bin/zb"; do
        if [ -x "$candidate" ]; then
            export PATH="$(dirname "$candidate"):$PATH"
            return 0
        fi
    done

    return 1
}

if ensure_zb_available; then
    echo "zerobrew is already installed: $(command -v zb)"
    exit 0
fi

echo "Installing zerobrew..."
# See: https://github.com/lucasgelfond/zerobrew
installer=$(mktemp)
curl -fsSL https://zerobrew.rs/install -o "$installer"
bash "$installer"
rm -f "$installer"

if ensure_zb_available; then
    echo "zerobrew is ready: $(command -v zb)"
else
    echo "Warning: zerobrew installation failed. Homebrew will be used as fallback."
fi
