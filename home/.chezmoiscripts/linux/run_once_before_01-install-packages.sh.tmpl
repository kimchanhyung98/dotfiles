#!/bin/bash
#
# Install essential packages: curl, git, vim, zsh, ghostty
# Runs once on first setup

{{ if ne .chezmoi.os "linux" }}
exit 0
{{ end }}

set -eufo pipefail

echo "[install-packages]"

# 필수 패키지 목록
packages=(curl git vim zsh)

# 미설치 패키지 확인
install_needed=()
for pkg in "${packages[@]}"; do
    if ! command -v "$pkg" &>/dev/null; then
        install_needed+=("$pkg")
    fi
done

if [ ${#install_needed[@]} -eq 0 ]; then
    echo "All essential packages are already installed."
else
    echo "Installing packages: ${install_needed[*]}"

    # root가 아닌 경우 sudo 사용
    sudo_cmd=""
    if [ "$(id -u)" -ne 0 ]; then
        if command -v sudo &>/dev/null; then
            sudo_cmd="sudo"
        else
            echo "Error: Not running as root and 'sudo' is not available."
            echo "Please install manually: ${install_needed[*]}"
            exit 1
        fi
    fi

    # 배포판별 패키지 매니저 자동 감지 (apt-get, dnf, yum)
    if command -v apt-get &>/dev/null; then
        $sudo_cmd apt-get update -qq
        $sudo_cmd apt-get install -y -qq "${install_needed[@]}"
    elif command -v dnf &>/dev/null; then
        $sudo_cmd dnf install -y -q "${install_needed[@]}"
    elif command -v yum &>/dev/null; then
        $sudo_cmd yum install -y -q "${install_needed[@]}"
    else
        echo "Error: No supported package manager found (apt-get, dnf, yum)."
        echo "Please install manually: ${install_needed[*]}"
        exit 1
    fi
fi

# Ghostty
# - GPU 가속 터미널 에뮬레이터 (표준 저장소 미포함, 수동 설치 필요)
if ! command -v ghostty &>/dev/null; then
    echo "Note: Ghostty requires manual installation on Linux."
    echo "  See: https://ghostty.org/docs/install/linux"
fi

echo "[install-packages] done"
