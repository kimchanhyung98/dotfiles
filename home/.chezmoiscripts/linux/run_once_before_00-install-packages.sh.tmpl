#!/bin/bash
#
# Install essential packages (Linux only)
# Runs once on first setup

{{ if ne .chezmoi.os "linux" }}
exit 0
{{ end }}

set -eufo pipefail

echo "Checking essential packages..."

packages=(
    curl
    git
    vim
    zsh
)

install_needed=()

for pkg in "${packages[@]}"; do
    if ! command -v "$pkg" &>/dev/null; then
        install_needed+=("$pkg")
    fi
done

if [ ${#install_needed[@]} -eq 0 ]; then
    echo "All essential packages are already installed."
    exit 0
fi

echo "Installing packages: ${install_needed[*]}"

sudo_cmd=""
if [ "$(id -u)" -ne 0 ]; then
    if command -v sudo &>/dev/null; then
        sudo_cmd="sudo"
    else
        echo "Warning: Not running as root and 'sudo' is not available."
        echo "Please install the following packages manually: ${install_needed[*]}"
        exit 1
    fi
fi

if command -v apt-get &>/dev/null; then
    $sudo_cmd apt-get update -qq
    $sudo_cmd apt-get install -y -qq "${install_needed[@]}"
elif command -v dnf &>/dev/null; then
    $sudo_cmd dnf install -y -q "${install_needed[@]}"
elif command -v yum &>/dev/null; then
    $sudo_cmd yum install -y -q "${install_needed[@]}"
else
    echo "Warning: No supported package manager found (apt-get, dnf, yum)."
    echo "Please install the following packages manually: ${install_needed[*]}"
    exit 1
fi

echo "Essential packages installation complete."
